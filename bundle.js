function drawArrayToCanvas(a){canvas.width=a[0].length,canvas.height=a.length;for(var b=20,c=0,d=Array.prototype.concat.apply([],a),e=0;e<d.length;e++)b<d[e]?b=d[e]:c>d[e]&&(c=d[e]);for(var f=context.getImageData(0,0,canvas.width,canvas.height),g=f.width,h=f.height,i=f.data,j=[],k=0;k<h;++k)for(var l=0;l<g;++l){var m=4*(k*g+l),n=a[k][l],o=255*(n-c)/(b-c),p=255-o;i[m+0]=p,i[m+1]=p,i[m+2]=p,i[m+3]=255;var q=startLatitude-k*widthLongitude,r=startLongitude+l*widthLatitude;0!=o&&j.push({location:new google.maps.LatLng(q,r),weight:o})}canvas.style.display="block",document.getElementById("drop_msg").style.display="none",context.putImageData(f,0,0),null!=heatmap&&heatmap.setMap(null),heatmap=new google.maps.visualization.HeatmapLayer({data:j,radius:10,maxIntensity:255,opacity:.4}),heatmap.setMap(map)}function handleFileSelect(a){a.stopPropagation(),a.preventDefault();var b=a.dataTransfer.files,c=b[0],d=(escape(c.name),new FileReader);d.onload=function(a){return function(a){meshArray=convertCsvToArray(d.result),drawArrayToCanvas(meshArray)}}(),d.readAsText(c)}function convertCsvToArray(a){return a.split("\n").filter(function(a){return""!=a}).map(function(a){return a.split(",").filter(function(a){return""!=a})})}function handleDragOver(a){a.stopPropagation(),a.preventDefault(),a.dataTransfer.dropEffect="copy"}function onMouseOver(a){}function onMouseOut(a){}function onMouseMove(a){if(null!=meshArray){var b=a.target.getBoundingClientRect();x=a.clientX-b.left,y=a.clientY-b.top,latitude=Math.round(1e4*(startLatitude-y*widthLongitude),4)/1e4,longitude=Math.round(1e4*(startLongitude+x*widthLatitude),4)/1e4,value=meshArray[y][x],document.getElementById("pos").innerHTML="("+x+" , "+y+")",document.getElementById("lati").innerHTML="("+latitude+" , "+longitude+")",document.getElementById("value").innerHTML=value+" mm",document.getElementById("v_m1m1").innerHTML=meshArray[y-1][x-1],document.getElementById("v_0m1").innerHTML=meshArray[y-1][x],document.getElementById("v_p1m1").innerHTML=meshArray[y-1][x+1],document.getElementById("v_m10").innerHTML=meshArray[y][x-1],document.getElementById("v_00").innerHTML=meshArray[y][x],document.getElementById("v_p10").innerHTML=meshArray[y][x+1],document.getElementById("v_m1p1").innerHTML=meshArray[y+1][x-1],document.getElementById("v_0p1").innerHTML=meshArray[y+1][x],document.getElementById("v_p1p1").innerHTML=meshArray[y+1][x+1]}}function onClick(a){null!=meshArray&&(view_map(latitude,longitude),document.getElementById("click_pos").innerHTML="("+x+" , "+y+")",document.getElementById("click_lati").innerHTML="("+latitude+" , "+longitude+")",document.getElementById("click_value").innerHTML=value+" mm")}function view_map(a,b){var c=new google.maps.LatLng(a,b);map.panTo(c),marker.setMap(map),marker.setPosition(c)}var meshArray=null,startLatitude=46.7,startLongitude=120,widthLatitude=.0625,widthLongitude=.05,x,y,latitude,longitude,value,canvas=document.getElementById("mycanvas"),context=canvas.getContext("2d");canvas.addEventListener("mouseover",onMouseOver,!1),canvas.addEventListener("mouseout",onMouseOut,!1),canvas.addEventListener("mousemove",onMouseMove,!1),canvas.addEventListener("click",onClick,!1);var dropZone=document.getElementById("drop_zone");dropZone.addEventListener("dragover",handleDragOver,!1),dropZone.addEventListener("drop",handleFileSelect,!1);var latlng=new google.maps.LatLng(38.65,138.25),opts={zoom:5,center:latlng,mapTypeId:google.maps.MapTypeId.ROADMAP},map=new google.maps.Map(document.getElementById("map_canvas"),opts),marker=new google.maps.Marker({position:latlng}),heatmap=null;